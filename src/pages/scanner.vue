<template>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div class="max-w-2xl mx-auto">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">
          üéØ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        </h1>
        <p class="text-gray-600">
          –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        </p>
      </div>

      <!-- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã -->
      <div v-if="!scannedData" class="bg-white rounded-lg shadow-lg p-8">
        <div class="mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
          </h2>
          <qrcode-stream
              @detect="onDetect"
              @error="onError"
              class="w-full rounded-lg overflow-hidden border-2 border-blue-300"
          />
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <Message
            v-if="errorMessage"
            severity="error"
            :text="errorMessage"
            class="w-full mb-4"
        />

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <Message
            v-if="scanSuccess"
            severity="success"
            text="QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!"
            class="w-full"
        />
      </div>

      <!-- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã -->
      <div v-else class="bg-white rounded-lg shadow-lg p-8">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ -->
        <div
            class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50
                 rounded-lg border border-blue-200"
        >
          <h2 class="text-2xl font-bold text-gray-800 mb-2">üë§ –°—Ç—É–¥–µ–Ω—Ç</h2>
          <p class="text-lg">
            <span class="font-semibold">ID:</span>
            <span class="text-blue-600">{{ scannedData.studentId }}</span>
          </p>
          <p class="text-gray-600 mt-1">
            {{ studentInfo.name || '–°—Ç—É–¥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' }}
          </p>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
          </h2>

          <div v-if="achievementsList.length > 0" class="space-y-3">
            <div
                v-for="achievement in achievementsList"
                :key="achievement.id"
                class="flex items-center justify-between p-4 bg-gradient-to-r
                     from-amber-50 to-yellow-50 rounded-lg border
                     border-amber-200 hover:shadow-md transition-shadow"
            >
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">
                  {{ achievement.name }}
                </h3>
                <p class="text-sm text-gray-600">
                  {{ achievement.description }}
                </p>
              </div>
              <div class="ml-4 text-right">
                <span
                    class="inline-block px-3 py-1 bg-yellow-200
                         text-yellow-800 rounded-full font-bold text-sm"
                >
                  +{{ achievement.experience }} –æ–ø—ã—Ç–∞
                </span>
              </div>
            </div>
          </div>

          <div
              v-else
              class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg"
          >
            –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
          </div>
        </div>

        <!-- –°—É–º–º–∞—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div
            class="mb-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50
                 rounded-lg border-2 border-green-300"
        >
          <h3 class="text-lg font-semibold text-gray-800 mb-2">
            ‚ú® –°—É–º–º–∞—Ä–Ω—ã–π –æ–ø—ã—Ç
          </h3>
          <p class="text-4xl font-bold text-green-600">
            {{ totalExperience }}
            <span class="text-lg text-gray-600">–æ–ø—ã—Ç–∞</span>
          </p>
          <p class="text-gray-600 mt-2">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {{ achievementsList.length }}
          </p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="flex gap-4">
          <Button
              label="–í—ã–ø–æ–ª–Ω–∏—Ç—å"
              icon="pi pi-check"
              class="flex-1"
              size="large"
              @click="completeAchievements"
              :loading="isLoading"
              severity="success"
              :pt="{
              root: {
                class: 'rounded-lg font-semibold uppercase tracking-wide ransition-all duration-200'
              },
              label: {
                class: 'font-bold text-base'
              },
              icon: {
                class: 'mr-2'
              },
              loadingIcon: {
                class: 'mr-2 animate-spin'
              }
            }"
          />

          <Button
              label="–û—Ç–º–µ–Ω–∞"
              icon="pi pi-times"
              class="flex-1"
              size="large"
              @click="resetScan"
              severity="secondary"
              :pt="{
              root: {
                class: 'rounded-lg font-semibold uppercase tracking-wide transition-all duration-200'
              },
              label: {
                class: 'font-bold text-base'
              },
              icon: {
                class: 'mr-2'
              }
            }"
          />
        </div>
      </div>

      <!-- Toast -->
      <Toast
          :pt="{
          root: {
            class: 'p-4'
          },
          message: {
            class: 'ml-3'
          },
          summary: {
            class: 'font-bold text-base'
          },
          detail: {
            class: 'text-sm mt-1'
          },
          closeButton: {
            class: 'hover:bg-opacity-20 rounded-full'
          }
        }"
      />
    </div>
  </div>
</template>

<script setup>
import {ref, computed} from 'vue'
import {QrcodeStream} from 'vue-qrcode-reader'
import Button from 'primevue/button'
import Message from 'primevue/message'
import Toast from 'primevue/toast'
import {useToast} from 'primevue/usetoast'

const toast = useToast()

// –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const scannedData = ref(null)
const errorMessage = ref('')
const scanSuccess = ref(false)
const isLoading = ref(false)

// –ü—Ä–∏–º–µ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
const studentsDb = {
  '1': {id: '1', name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤'},
  '2': {id: '2', name: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞'},
  '3': {id: '3', name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ò–≤–∞–Ω–æ–≤'}
}

const achievementsDb = {
  '1': {
    id: '1',
    name: '–ü–µ—Ä–≤—ã–π —à–∞–≥',
    description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–≤—ã–π –∫—É—Ä—Å',
    experience: 100
  },
  '2': {
    id: '2',
    name: '–û—Ç–ª–∏—á–Ω–∏–∫',
    description: '–ü–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É 5 –ø–æ —Ç–µ—Å—Ç—É',
    experience: 250
  },
  '3': {
    id: '3',
    name: '–ß–µ–º–ø–∏–æ–Ω',
    description: '–í—ã–∏–≥—Ä–∞—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É',
    experience: 500
  },
  '4': {
    id: '4',
    name: '–ü–æ–º–æ—â–Ω–∏–∫',
    description: '–ü–æ–º–æ—á—å –æ–¥–Ω–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º',
    experience: 150
  },
  '5': {
    id: '5',
    name: '–õ–∏–¥–µ—Ä',
    description: '–í–æ–∑–≥–ª–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç',
    experience: 300
  }
}

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ
const studentInfo = computed(() => {
  if (!scannedData.value) return {}
  return (
      studentsDb[scannedData.value.studentId] || {
        name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç'
      }
  )
})

// –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
const achievementsList = computed(() => {
  if (!scannedData.value || !scannedData.value.achievementIds) return []
  return scannedData.value.achievementIds
      .map(id => achievementsDb[id])
      .filter(Boolean)
})

// –°—É–º–º–∞—Ä–Ω—ã–π –æ–ø—ã—Ç
const totalExperience = computed(() => {
  return achievementsList.value.reduce(
      (sum, achievement) => sum + achievement.experience,
      0
  )
})

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const onDetect = detectedCodes => {
  if (!detectedCodes || detectedCodes.length === 0) return

  const decodedText = detectedCodes[0]?.rawValue

  if (!decodedText) return

  console.log("scan", decodedText)

  try {
    // –ü–∞—Ä—Å–∏—Ä—É–µ–º QR-–∫–æ–¥: studentId:achievement1Id:achievement2Id:...
    const parts = decodedText.split(':')
    if (parts.length < 2) {
      throw new Error(
          '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è: studentId:achievementId1:achievementId2:...'
      )
    }

    const studentId = parts[0]
    const achievementIds = parts.slice(1)

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!studentsDb[studentId]) {
      throw new Error('–°—Ç—É–¥–µ–Ω—Ç —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω')
    }

    scannedData.value = {
      studentId,
      achievementIds
    }

    scanSuccess.value = true
    errorMessage.value = ''
  } catch (error) {
    errorMessage.value = error.message
    scanSuccess.value = false
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
const onError = error => {
  console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error)
  errorMessage.value = `–û—à–∏–±–∫–∞: ${error.name || error.message}`
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
const completeAchievements = async () => {
  if (!scannedData.value) return

  isLoading.value = true

  try {
    // –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    await new Promise(resolve => setTimeout(resolve, 1500))

    toast.add({
      severity: 'success',
      summary: '–£—Å–ø–µ—à–Ω–æ!',
      detail: `–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${scannedData.value.studentId}
               –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –û–ø—ã—Ç: ${totalExperience.value}`,
      life: 3000
    })

    resetScan()
  } catch (error) {
    toast.add({
      severity: 'error',
      summary: '–û—à–∏–±–∫–∞',
      detail: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
      life: 3000
    })
  } finally {
    isLoading.value = false
  }
}

// –°–±—Ä–æ—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const resetScan = () => {
  scannedData.value = null
  errorMessage.value = ''
  scanSuccess.value = false
}
</script>

<style scoped>
/* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Tailwind –∫–ª–∞—Å—Å—ã –∏ Pass-Through API */
</style>